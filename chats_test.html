<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chats - Chat App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #7E57C2;
            --primary-light: #b085f5;
            --primary-dark: #4d2c91;
            --secondary-color: #FF4081;
            --background-color: #f5f7fb;
            --card-background: #ffffff;
            --text-color: #333333;
            --light-text-color: #666666;
            --lighter-text-color: #888888;
            --border-color: #e0e0e0;
            --hover-effect: rgba(126, 87, 194, 0.08);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
            --border-radius: 16px;
            --transition: all 0.3s ease;
            --online-status: #4CAF50;
            --offline-status: #9E9E9E;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background-color: var(--card-background);
            box-shadow: var(--shadow);
            padding: 0.8rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            font-weight: 700;
            font-size: 1.4rem;
            color: var(--primary-color);
        }

        .nav-brand i {
            margin-right: 0.5rem;
            font-size: 1.6rem;
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
        }

        .navbar a {
            color: var(--light-text-color);
            text-decoration: none;
            padding: 0.6rem 1rem;
            font-weight: 500;
            border-radius: 50px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .navbar a i {
            font-size: 1.1rem;
        }

        .navbar a.active, .navbar a:hover {
            background-color: var(--hover-effect);
            color: var(--primary-color);
        }

        #logout-btn {
            color: var(--secondary-color);
        }

        #logout-btn:hover {
            background-color: rgba(255, 64, 129, 0.08);
        }

        .chat-main-content {
            flex: 1;
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem;
            height: calc(100vh - 70px);
        }

        .friends-list-container {
            background-color: var(--card-background);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 320px;
            height: 100%;
            overflow-y: auto;
            transition: var(--transition);
        }

        .friends-list-container h3 {
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            color: var(--primary-dark);
            padding-bottom: 0.8rem;
            border-bottom: 1px solid var(--border-color);
        }

        #friends-list {
            list-style-type: none;
        }

        .friend-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .friend-item:hover {
            background-color: var(--hover-effect);
        }

        .friend-item.active {
            background-color: var(--hover-effect);
            border-left: 4px solid var(--primary-color);
        }

        .friend-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            margin-right: 1rem;
            position: relative;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .friend-status {
            font-size: 0.85rem;
            color: var(--lighter-text-color);
            display: flex;
            align-items: center;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-online {
            background-color: var(--online-status);
        }

        .status-offline {
            background-color: var(--offline-status);
        }

        .chat-window-container {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        #chat-header {
            padding: 1.2rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--card-background);
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }

        .chat-friend-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .chat-friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .chat-friend-details h4 {
            font-size: 1.1rem;
            margin-bottom: 0.2rem;
        }

        .chat-friend-details p {
            font-size: 0.85rem;
            color: var(--lighter-text-color);
            display: flex;
            align-items: center;
        }

        .call-buttons {
            display: flex;
            gap: 0.8rem;
        }

        .call-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--hover-effect);
            color: var(--primary-color);
            border: none;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.1rem;
        }

        .call-btn:hover {
            background-color: var(--primary-color);
            color: white;
            transform: scale(1.05);
        }

        #messages-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background-color: #f9f9fb;
        }

        .message {
            max-width: 70%;
            padding: 0.9rem 1.2rem;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }

        .message.sent {
            background-color: var(--primary-color);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            background-color: #e9e9eb;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 0.7rem;
            margin-top: 0.4rem;
            opacity: 0.8;
            text-align: right;
        }

        .message img {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 0.5rem;
        }

        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--lighter-text-color);
            text-align: center;
        }

        .empty-chat i {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            color: #e0e0e0;
        }

        /* NEW: Message Input Container with Auto-resizing */
        .message-input-container {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: flex-end;
            gap: 0.8rem;
            background-color: var(--card-background);
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
        }

        .input-wrapper {
            flex-grow: 1;
            display: flex;
            background-color: #f0f2f5;
            border-radius: 24px;
            padding: 0.5rem;
            align-items: flex-end;
            min-height: 50px;
        }

        #message-input {
            flex-grow: 1;
            padding: 0.6rem 1rem;
            border: none;
            background: transparent;
            font-size: 1rem;
            resize: none;
            max-height: 120px;
            overflow-y: auto;
            outline: none;
            line-height: 1.4;
        }

        #message-input::placeholder {
            color: var(--lighter-text-color);
        }

        .file-label {
            cursor: pointer;
            font-size: 1.4rem;
            color: var(--light-text-color);
            padding: 0.6rem;
            border-radius: 50%;
            transition: var(--transition);
            align-self: flex-end;
            margin-bottom: 0.2rem;
        }

        .file-label:hover {
            background-color: var(--hover-effect);
            color: var(--primary-color);
        }

        #send-btn {
            padding: 0.7rem 1.2rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            align-self: flex-end;
            margin-bottom: 0.2rem;
        }

        #send-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive Design */
        @media (max-width: 900px) {
            .chat-main-content {
                flex-direction: column;
                height: auto;
                padding: 1rem;
            }
            
            .friends-list-container {
                width: 100%;
                height: 300px;
                margin-bottom: 1rem;
            }
            
            .chat-window-container {
                min-height: 500px;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 0.8rem 1rem;
                flex-wrap: wrap;
            }
            
            .nav-links {
                order: 3;
                width: 100%;
                overflow-x: auto;
                padding: 0.5rem 0;
                margin-top: 0.5rem;
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            
            .nav-links::-webkit-scrollbar {
                display: none;
            }
            
            .chat-main-content {
                padding: 1rem;
            }
            
            .message {
                max-width: 85%;
            }
        }

        @media (max-width: 480px) {
            .navbar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .nav-brand {
                margin-bottom: 0.5rem;
            }
            
            .nav-links {
                width: 100%;
                justify-content: space-between;
            }
            
            .navbar a {
                padding: 0.5rem;
                font-size: 0.9rem;
            }
            
            .navbar a span {
                display: none;
            }
            
            .navbar a i {
                font-size: 1.3rem;
                margin-right: 0;
            }
            
            .message-input-container {
                padding: 0.8rem;
            }
            
            #send-btn {
                padding: 0.7rem;
            }
            
            #send-btn span {
                display: none;
            }
            
            .call-buttons {
                gap: 0.5rem;
            }
            
            .call-btn {
                width: 35px;
                height: 35px;
            }
            
            .input-wrapper {
                min-height: 45px;
            }
            
            #message-input {
                padding: 0.5rem 0.8rem;
            }
        }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="nav-brand">
            <i class="fas fa-comment-dots"></i>
            <span>ChatApp</span>
        </div>
        <div class="nav-links">
            <a href="home_test.html"><i class="fas fa-home"></i> <span>Home</span></a>
            <a href="chats_test.html" class="active"><i class="fas fa-comments"></i> <span>Chats</span></a>
            <a href="requests_test.html"><i class="fas fa-user-friends"></i> <span>Requests</span></a>
            <a href="calls_test.html"><i class="fas fa-phone"></i> <span>Calls</span></a>
            <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a>
        </div>
    </header>
    <main class="chat-main-content">
        <div class="friends-list-container">
            <h3>Friends</h3>
            <ul id="friends-list">
                <li class="empty-state">
                    <i class="fas fa-users"></i>
                    <p>Your friends will appear here</p>
                </li>
            </ul>
        </div>
        <div class="chat-window-container">
            <div id="chat-header">
                <div class="chat-friend-info">
                    <div class="chat-friend-avatar">U</div>
                    <div class="chat-friend-details">
                        <h4 id="chat-friend-name">Select a friend to chat</h4>
                        <p id="friend-status-text">Tap on a friend to start chatting</p>
                    </div>
                </div>
                <div class="call-buttons">
                    <button id="call-btn" class="call-btn" style="display: none;">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button id="video-call-btn" class="call-btn" style="display: none;">
                        <i class="fas fa-video"></i>
                    </button>
                </div>
            </div>
            <div id="messages-container">
                <div class="empty-chat">
                    <i class="fas fa-comments"></i>
                    <p>Select a friend to view your conversation</p>
                </div>
            </div>
            <!-- NEW: Updated message input container with auto-resizing -->
            <div class="message-input-container">
                <div class="input-wrapper">
                    <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
                </div>
                <label for="file-input" class="file-label">
                    <i class="fas fa-paperclip"></i>
                </label>
                <input type="file" id="file-input" style="display: none;">
                <button id="send-btn">
                    <i class="fas fa-paper-plane"></i>
                    <span>Send</span>
                </button>
            </div>
        </div>
    </main>

    <audio id="call-ringtone" src="sounds/ringtone.mp3" preload="auto"></audio>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>
        /* ================= Firebase Init ================= */
        const firebaseConfig = {
            apiKey: "AIzaSyBAyx04GN-5MsBSztE2TQ4zViMs81iCFI8",
            authDomain: "trext-91b51.firebaseapp.com",
            databaseURL: "https://trext-91b51-default-rtdb.firebaseio.com",
            projectId: "trext-91b51",
            storageBucket: "trext-91b51.firebasestorage.app",
            messagingSenderId: "396150208973",
            appId: "1:396150208973:web:1e6ca3f5ce9fed7a5cec84",
            measurementId: "G-VVVKCLZYEE"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        /* ================= UI Elements ================= */
        const friendsList = document.getElementById('friends-list');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const fileInput = document.getElementById('file-input');
        const sendBtn = document.getElementById('send-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const callBtn = document.getElementById('call-btn');
        const videoCallBtn = document.getElementById('video-call-btn');
        const chatFriendName = document.getElementById('chat-friend-name');
        const friendStatusText = document.getElementById('friend-status-text');
        const callRingtone = document.getElementById('call-ringtone');

        let currentUser;
        let currentChatFriendId = null;
        let currentChatFriendName = null;
        let chatRefListener = null;
        let callTimeoutTimer = null;
        let friendStatusListener = null;

        /* ================= NEW: Auto-resize textarea ================= */
        function autoResizeTextarea() {
            messageInput.style.height = 'auto';
            messageInput.style.height = (messageInput.scrollHeight) + 'px';
            
            // Adjust container padding if needed
            const inputWrapper = document.querySelector('.input-wrapper');
            if (messageInput.scrollHeight > 80) {
                inputWrapper.style.alignItems = 'flex-start';
            } else {
                inputWrapper.style.alignItems = 'flex-end';
            }
        }

        messageInput.addEventListener('input', autoResizeTextarea);
        
        // Reset textarea height when message is sent
        function resetTextarea() {
            messageInput.style.height = 'auto';
            const inputWrapper = document.querySelector('.input-wrapper');
            inputWrapper.style.alignItems = 'flex-end';
        }

        /* ================= Auth ================= */
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loadFriendsList();
                listenForIncomingCalls();
                updateUserOnlineStatus(true);
                
                // Set up online status when user leaves
                window.addEventListener('beforeunload', () => {
                    updateUserOnlineStatus(false);
                });
            } else {
                window.location.href = 'index.html';
            }
        });

        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            updateUserOnlineStatus(false);
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            });
        });

        /* ================= Online Status ================= */
        function updateUserOnlineStatus(isOnline) {
            if (!currentUser) return;
            
            const statusRef = database.ref(`users/${currentUser.uid}/status`);
            const userStatusRef = database.ref('.info/connected');
            
            if (isOnline) {
                userStatusRef.on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        statusRef.onDisconnect().set({
                            state: 'offline',
                            last_changed: firebase.database.ServerValue.TIMESTAMP
                        }).then(() => {
                            statusRef.set({
                                state: 'online',
                                last_changed: firebase.database.ServerValue.TIMESTAMP
                            });
                        });
                    }
                });
            } else {
                statusRef.set({
                    state: 'offline',
                    last_changed: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        /* ================= Friends ================= */
        function loadFriendsList() {
            const friendsRef = database.ref(`friends/${currentUser.uid}`);
            friendsRef.on('value', (snapshot) => {
                friendsList.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const friendId = childSnapshot.key;
                        database.ref(`users/${friendId}`).once('value', (userSnapshot) => {
                            const friend = userSnapshot.val();
                            const li = document.createElement('li');
                            li.classList.add('friend-item');
                            
                            // Get user initial for avatar
                            const userInitial = friend.username ? friend.username.charAt(0).toUpperCase() : 'F';
                            
                            li.innerHTML = `
                                <div class="friend-avatar">${userInitial}</div>
                                <div class="friend-info">
                                    <div class="friend-name">${friend.username}</div>
                                    <div class="friend-status">
                                        <span class="status-indicator status-offline"></span>
                                        <span class="status-text">Offline</span>
                                    </div>
                                </div>
                            `;
                            li.dataset.friendId = friendId;
                            friendsList.appendChild(li);
                            
                            // Listen for status changes
                            database.ref(`users/${friendId}/status`).on('value', (statusSnapshot) => {
                                const status = statusSnapshot.val();
                                const statusElem = li.querySelector('.status-indicator');
                                const statusTextElem = li.querySelector('.status-text');
                                
                                if (status && status.state === 'online') {
                                    statusElem.classList.add('status-online');
                                    statusElem.classList.remove('status-offline');
                                    statusTextElem.textContent = 'Online';
                                } else {
                                    statusElem.classList.add('status-offline');
                                    statusElem.classList.remove('status-online');
                                    statusTextElem.textContent = 'Offline';
                                }
                            });
                        });
                    });
                } else {
                    friendsList.innerHTML = `
                        <li class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>No friends found. Add friends from the home page.</p>
                        </li>
                    `;
                }
            });
        }

        friendsList.addEventListener('click', (e) => {
            const friendItem = e.target.closest('.friend-item');
            if (friendItem) {
                // Remove active class from all friends
                document.querySelectorAll('.friend-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Add active class to selected friend
                friendItem.classList.add('active');
                
                currentChatFriendId = friendItem.dataset.friendId;
                currentChatFriendName = friendItem.querySelector('.friend-name').textContent;
                
                // Update chat header
                chatFriendName.textContent = currentChatFriendName;
                
                // Get user initial for avatar
                const userInitial = currentChatFriendName.charAt(0).toUpperCase();
                document.querySelector('.chat-friend-avatar').textContent = userInitial;
                
                // Show call buttons
                callBtn.style.display = 'flex';
                videoCallBtn.style.display = 'flex';
                
                // Clear messages and load chat history
                messagesContainer.innerHTML = '';
                loadChatHistory(currentChatFriendId);
                
                // Update friend status in chat header
                if (friendStatusListener) {
                    friendStatusListener.off();
                }
                
                friendStatusListener = database.ref(`users/${currentChatFriendId}/status`).on('value', (snapshot) => {
                    const status = snapshot.val();
                    if (status && status.state === 'online') {
                        friendStatusText.innerHTML = '<span class="status-indicator status-online"></span> Online';
                    } else {
                        friendStatusText.innerHTML = '<span class="status-indicator status-offline"></span> Offline';
                    }
                });
            }
        });

        /* ================= Calling ================= */
        callBtn.addEventListener('click', () => {
            if (currentChatFriendId) {
                initiateCall(currentChatFriendId, 'voice');
            }
        });
        
        videoCallBtn.addEventListener('click', () => {
            if (currentChatFriendId) {
                initiateCall(currentChatFriendId, 'video');
            }
        });

        /** Caller side: create ringing entry + open call window */
        function initiateCall(calleeId, type) {
            const callData = {
                callerId: currentUser.uid,
                callerName: currentUser.displayName || 'Unknown',
                type,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'ringing'
            };

            const callRef = database.ref(`calls/${calleeId}`).push();
            const callKey = callRef.key;

            callRef.set(callData).then(() => {
                // Open call window immediately so offer generate ho sake
                const url = `call_test.html?friendId=${calleeId}&type=${type}`;
                window.open(url, '_blank', 'noopener,noreferrer');

                // Play local ring until callee accepts
                callRingtone.play();
                callTimeoutTimer = setTimeout(() => {
                    callRingtone.pause();
                    callRingtone.currentTime = 0;
                    database.ref(`calls/${calleeId}/${callKey}`).remove();
                    alert('Call timed out.');
                }, 30000);

                // Stop ringing once active call established
                const composite = `${currentUser.uid}_${calleeId}`;
                database.ref('activeCalls')
                    .orderByChild('composite')
                    .equalTo(composite)
                    .limitToFirst(1)
                    .on('child_added', () => {
                        if (callTimeoutTimer) clearTimeout(callTimeoutTimer);
                        callRingtone.pause();
                        callRingtone.currentTime = 0;
                    });
            });
        }

        /** Callee side: listen for incoming ringing */
        function listenForIncomingCalls() {
            const callsRef = database.ref(`calls/${currentUser.uid}`);
            callsRef.on('child_added', (snapshot) => {
                const call = snapshot.val();
                if (!call) return;

                if (call.status === 'ringing') {
                    const callerName = call.callerName || 'Unknown User';
                    const callType = call.type === 'video' ? 'Video Call' : 'Voice Call';

                    const accept = confirm(`${callerName} is calling you. Accept ${callType}?`);
                    const callId = snapshot.key;

                    if (accept) {
                        const url = `call_test.html?callId=${callId}&callerId=${call.callerId}&type=${call.type}`;
                        window.open(url, '_blank', 'noopener,noreferrer');
                    }

                    // Remove ringing entry (accept or decline both)
                    database.ref(`calls/${currentUser.uid}/${callId}`).remove();
                }
            });
        }

        /* ================= Messaging ================= */
        function loadChatHistory(friendId) {
            if (chatRefListener) {
                chatRefListener.off();
            }
            const chatRoomId = getChatRoomId(currentUser.uid, friendId);
            const chatRef = database.ref(`chat_rooms/${chatRoomId}`);
            chatRefListener = chatRef.orderByChild('timestamp').on('child_added', (snapshot) => {
                const message = snapshot.val();
                displayMessage(message);
            });
        }

        function getChatRoomId(userId1, userId2) {
            return userId1 < userId2 ? `${userId1}-${userId2}` : `${userId2}-${userId1}`;
        }

        function displayMessage(message) {
            // Remove empty state if it exists
            const emptyChat = document.querySelector('.empty-chat');
            if (emptyChat) {
                emptyChat.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            if (message.senderId === currentUser.uid) {
                messageDiv.classList.add('sent');
            } else {
                messageDiv.classList.add('received');
            }

            if (message.type === 'text') {
                messageDiv.textContent = message.content;
            } else if (message.type === 'image') {
                messageDiv.innerHTML = `<img src="${message.content}" alt="Shared Image" style="max-width: 100%; border-radius: 12px;">`;
            }
            
            // Add timestamp
            const timestamp = document.createElement('div');
            timestamp.classList.add('message-time');
            
            if (message.timestamp) {
                const date = new Date(message.timestamp);
                timestamp.textContent = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } else {
                timestamp.textContent = 'Just now';
            }
            
            messageDiv.appendChild(timestamp);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        sendBtn.addEventListener('click', () => {
            sendMessageIfValid();
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessageIfValid();
            }
        });

        function sendMessageIfValid() {
            const messageText = messageInput.value.trim();
            if (messageText !== '' && currentChatFriendId) {
                sendMessage(messageText, 'text');
                messageInput.value = '';
                resetTextarea();
            }
        }

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && currentChatFriendId) {
                uploadFile(file);
            }
        });

        function sendMessage(content, type) {
            const chatRoomId = getChatRoomId(currentUser.uid, currentChatFriendId);
            const newMessageRef = database.ref(`chat_rooms/${chatRoomId}`).push();
            newMessageRef.set({
                senderId: currentUser.uid,
                content,
                type,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function uploadFile(file) {
            const storageRef = storage.ref(`shared_files/${currentUser.uid}/${file.name}`);
            const uploadTask = storageRef.put(file);

            uploadTask.on('state_changed', null,
                (error) => console.error('File upload failed:', error),
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        sendMessage(downloadURL, 'image');
                    });
                }
            );
        }
    </script>
</body>
</html>