<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trext - Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #007BFF;
      --secondary-color: #f0f2f5;
      --font-color: #333;
      --white: #ffffff;
      --border-color: #e0e0e0;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--secondary-color);
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .hidden { display: none; }

    /* Auth Page */
    #auth-container {
      width: 350px;
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      padding: 30px;
      text-align: center;
    }
    #auth-container h1 {
      color: var(--primary-color);
      margin-bottom: 20px;
    }
    #auth-container input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }
    #auth-container button {
      width: 100%;
      padding: 12px;
      background: var(--primary-color);
      color: var(--white);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }
    #toggle-auth {
      margin-top: 15px;
      font-size: 0.9em;
      cursor: pointer;
      color: var(--primary-color);
    }

    /* Chat Page */
    #chat-container {
      width: 100%;
      max-width: 700px;
      height: 90vh;
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: var(--primary-color);
      color: var(--white);
    }
    #user-profile { display: flex; align-items: center; gap: 10px; }
    #user-name { font-weight: bold; }
    #presence-status { font-size: 0.8em; color: #d1ffd1; }
    #logout-btn {
      background: transparent;
      border: 1px solid var(--white);
      color: var(--white);
      padding: 5px 15px;
      border-radius: 15px;
      cursor: pointer;
    }
    main#messages {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column-reverse;
      background: var(--secondary-color);
    }
    .message-item {
      display: flex;
      margin-bottom: 15px;
      max-width: 70%;
    }
    .message-content {
      background: var(--white);
      padding: 10px 15px;
      border-radius: 15px;
      word-wrap: break-word;
    }
    .message-sender { font-weight: 600; font-size: 0.9em; margin-bottom: 5px; }
    .message-text { font-size: 1em; }
    .message-time { font-size: 0.7em; color: #888; margin-top: 5px; text-align: right; }
    .message-item.mine { align-self: flex-end; }
    .message-item.mine .message-content {
      background: var(--primary-color);
      color: var(--white);
    }
    footer {
      padding: 12px;
      border-top: 1px solid var(--border-color);
      background: var(--white);
    }
    #message-form { display: flex; align-items: flex-end; }
    #message-input {
      flex-grow: 1;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 10px 15px;
      font-size: 1em;
      resize: none;
      min-height: 40px;
      max-height: 120px;
      overflow-y: auto;
    }
    #message-form button {
      background: var(--primary-color);
      color: var(--white);
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      margin-left: 10px;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      #chat-container {
        height: 100vh;
        width: 100vw;
        border-radius: 0;
      }
    }
  </style>
</head>
<body>

  <!-- Auth Page -->
  <div id="auth-container">
    <h1>Trext</h1>
    <p id="auth-title">Signup</p>
    <input type="text" id="username" placeholder="Username">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="auth-btn">Signup</button>
    <div id="toggle-auth">Already have an account? Login</div>
  </div>

  <!-- Chat Page -->
  <div id="chat-container" class="hidden">
    <header>
      <div id="user-profile">
        <span id="user-name"></span>
        <span id="presence-status"></span>
      </div>
      <button id="logout-btn">Logout</button>
    </header>
    <main id="messages"></main>
    <footer>
      <form id="message-form">
        <textarea id="message-input" placeholder="Enter your message..." autocomplete="off"></textarea>
        <button type="submit">Send</button>
      </form>
    </footer>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBAyx04GN-5MsBSztE2TQ4zViMs81iCFI8",
      authDomain: "trext-91b51.firebaseapp.com",
      databaseURL: "https://trext-91b51-default-rtdb.firebaseio.com",
      projectId: "trext-91b51",
      storageBucket: "trext-91b51.appspot.com",
      messagingSenderId: "396150208973",
      appId: "1:396150208973:web:1e6ca3f5ce9fed7a5cec84"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    const authContainer = document.getElementById('auth-container');
    const chatContainer = document.getElementById('chat-container');
    const authBtn = document.getElementById('auth-btn');
    const toggleAuth = document.getElementById('toggle-auth');
    const authTitle = document.getElementById('auth-title');
    const emailInput = document.getElementById('email');
    const passInput = document.getElementById('password');
    const usernameInput = document.getElementById('username');
    const userName = document.getElementById('user-name');
    const presenceStatus = document.getElementById('presence-status');
    const logoutBtn = document.getElementById('logout-btn');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const messagesDiv = document.getElementById('messages');

    let isSignup = true;

    toggleAuth.addEventListener('click', () => {
      isSignup = !isSignup;
      authTitle.textContent = isSignup ? "Signup" : "Login";
      authBtn.textContent = isSignup ? "Signup" : "Login";
      toggleAuth.textContent = isSignup ? "Already have an account? Login" : "Don't have an account? Signup";
      usernameInput.style.display = isSignup ? "block" : "none";
    });

    authBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const password = passInput.value.trim();
      const username = usernameInput.value.trim();
      try {
        if (isSignup) {
          const res = await auth.createUserWithEmailAndPassword(email, password);
          await db.ref("users/" + res.user.uid).set({ username, email });
        } else {
          await auth.signInWithEmailAndPassword(email, password);
        }
      } catch (err) { alert(err.message); }
    });

    logoutBtn.addEventListener('click', () => auth.signOut());

    auth.onAuthStateChanged(async user => {
      if (user) {
        authContainer.classList.add('hidden');
        chatContainer.classList.remove('hidden');
        const snap = await db.ref("users/" + user.uid).once("value");
        userName.textContent = snap.val().username || user.email;
        setPresence(user.uid);
        listenForMessages();
      } else {
        authContainer.classList.remove('hidden');
        chatContainer.classList.add('hidden');
      }
    });

    messageForm.addEventListener('submit', e => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;
      const uid = auth.currentUser.uid;
      db.ref('messages').push({
        uid,
        text,
        username: userName.textContent,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
      messageInput.value = '';
      messageInput.style.height = "40px";
    });

    // Auto resize input
    messageInput.addEventListener('input', () => {
      messageInput.style.height = "auto";
      messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + "px";
    });

    function listenForMessages() {
      messagesDiv.innerHTML = "";
      db.ref('messages').orderByChild('timestamp').limitToLast(25).on('child_added', snap => {
        const msg = snap.val();
        displayMessage(msg);
      });
    }

    function displayMessage(msg) {
      const div = document.createElement('div');
      div.classList.add('message-item');
      if (msg.uid === auth.currentUser.uid) div.classList.add('mine');
      const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
      div.innerHTML = `
        <div class="message-content">
          <div class="message-sender">${msg.username}</div>
          <div class="message-text">${msg.text}</div>
          <div class="message-time">${time}</div>
        </div>
      `;
      messagesDiv.prepend(div);
    }

    // Presence (online/offline)
    function setPresence(uid) {
      const userStatusRef = db.ref('/status/' + uid);
      const isOffline = { state: 'offline', last_changed: firebase.database.ServerValue.TIMESTAMP };
      const isOnline = { state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP };
      db.ref('.info/connected').on('value', snap => {
        if (snap.val() === false) return;
        userStatusRef.onDisconnect().set(isOffline).then(() => {
          userStatusRef.set(isOnline);
        });
      });
      userStatusRef.on('value', snap => {
        const val = snap.val();
        presenceStatus.textContent = val && val.state === 'online' ? '(online)' : '(offline)';
      });
    }
  </script>
</body>
</html>
